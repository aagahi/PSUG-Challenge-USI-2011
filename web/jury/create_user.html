<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Création d'un utilisateur</title>
    <script type="text/javascript" src="../js/jquery-1.5.1.min.js" ></script>
    <script type="text/javascript" src="../js/json2.js" ></script>
    <script type="text/javascript" src="../js/psug.js" ></script>
    <style type="text/css">
    .hide { display:none;}
    .show { display:inherit;}
	#user_form label { display:inline-block; width:150px; }
	#user_form input[type="submit"]{
	    background-color:orange ;
	    width:70px;
	    border-radius: 3em	; -moz-border-radius : 3em ; -webkit-border-radius:3em;
    }
	#usi_debug { width:80em; height:20em; overflow:auto; }
	#new_user_panel { display:none; }
    input.error { border-color:#ff0000; }
    div.error { color:#ff0000; font-weight:bold ; border: 1px solid #ff0000; margin-bottom:1em; padding: 0.5em 20px;}
    none {display:none;}
    </style>
</head>
<body>
    <h2>Enregistrez un nouveau joueur pour le quizz de l'année</h2>
    <form action="create_user.html" id="user_form">
    <div id="messages" class="none"></div>
	<label for="firstname">Prénom : </label>
	<input type="text" name="firstname" id="firstname" placeholder="prénom" required="true">
	<br>
	<label for="lastname">Nom : </label>
	<input name="lastname" id="lastname" placeholder="nom" required="true">
	<br>
	<label for="mail">Email : </label>
	<input type="email" name="mail" id="mail" placeholder="email" required="true">
	<br>
	<label for="password">Mot de passe : </label>
	<input type="password" name="password" id="password" placeholder="mot de passe" required="true">
	 <br>
	<input type="submit" name="submit" id="submit" value="valider">
    </form>
	<div id="result_panel"></div>
	<input type="button" id="new_user" value="Créer un nouvel utilisateur">
    <div id="usi_debug"></div>
    <script type="text/javascript">
	$(document).ready(function (){
        $("#new_user").hide();
	    var $dbg=$("#usi_debug");
	    var usi_log=function(msg){
		$dbg.html($dbg.html()+result);
	    };

	    $("#user_form") .submit(function (event){
            event.preventDefault();
            
            var data=$("#user_form").serializeJSON();
            var validate=function(key, value){
                input_class= (value.length<=2?"error":"");
                $("#"+key).attr("class", input_class);
            };
            $.each(data, validate);
            if ($("input.error").length) {
                $("#messages").attr("class", "error");
                $("#messages").html("Plusieurs champs sont en erreur.");
                return false;
            }
            $("#messages").attr("class", "none");
            $("#messages").html("");
            var success=function(result, status, jqXHR){
                usi_log("Resultat de la requête ajax:"+result);
                if(status==="201") {
                    $("#result_panel").html("L'utilisateur a bien été créé");
                } else  {
                    $("#result_panel").html("Etat inconnu lors de la création d'un utilisateur (ni 201 ni 400)");
                }
                $("#result_panel").show();
                $("#new_user").show();
                $("#submit").hide();
            };
            var error=function (jqXHR, textStatus, errorThrown) {
                $result_panel=$("#result_panel");
                $result_panel.addClass("error")
                if(jqXHR.status===400) {
                    $result_panel.html("Un utilisateur existe déjà correspondant à ces données");
                } else {
                    $result_panel.html("Etat inconnu lors de la création d'un utilisateur.<br />Message : "+textStatus+" : "+errorThrown+"<br />"+"Status: "+ jqXHR.status +"");
                    var st=jqXHR.serializeJSON();
                }
            };
            $.post('/api/user', JSON.stringify(data), success, "json").error(error);
            return false;
            });
            $("#new_user").click(function (){
                var cleanField=function(){
                    this.attr("value", "");
                    this.removeClass("error");
                };
                $("form input[type='text']").each (cleanField);
                $("form input[type='password']").each (cleanField);
                $("#result_panel").html("");
                $("#result_panel").removeClass("error")
                $("#new_user").hide();
                $("#firstname").focus();
                $("#submit").show();
	    });
	});
    </script>
</body>
</html>
